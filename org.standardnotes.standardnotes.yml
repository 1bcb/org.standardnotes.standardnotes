app-id: org.standardnotes.standardnotes
branch: stable
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '20.08'
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node14
# Electron doesn't use a traditional locale format so separate-locales is useless.
separate-locales: false
command: start-standardnotes
finish-args:
  - '--device=dri'
  - '--filesystem=xdg-download'
  - '--filesystem=xdg-documents'
  - '--filesystem=xdg-run/keyring'
  - '--share=ipc'
  - '--share=network'
  - '--socket=x11'
  - '--talk-name=org.freedesktop.Notifications'
  - '--talk-name=org.freedesktop.secrets'
modules:
  - shared-modules/python2.7/python-2.7.json
  - shared-modules/libsecret/libsecret.json
  - name: yarn
    buildsystem: simple
    build-commands:
      - 'cp -a * /app'
    # Only used for building, so clean it up afterwards.
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/yarnpkg/yarn/releases/download/v1.22.10/yarn-v1.22.10.tar.gz
        sha256: 7e433d4a77e2c79e6a7ae4866782608a8e8bcad3ec6783580577c59538381a6e
  - name: standardnotes
    buildsystem: simple
    build-options:
      # Add the node bin directory.
      append-path: '/usr/lib/sdk/node14/bin:/app/yarn/bin:/run/build/standardnotes/flatpak-node/chromedrive'
      env:
        # Don't add ELECTRON_CACHE
        XDG_CACHE_HOME: /run/build/standardnotes/flatpak-node/cache
        npm_config_nodedir: /usr/lib/sdk/node14
        npm_config_offline: 'true'
        npm_config_no_save: 'true'
        npm_config_cache: /run/build/standardnotes/flatpak-node/npm-cache
        npm_config_loglevel: 'verbose'
    build-commands:
      # Retire this at some point; (1) create a new task by default and (2) use Yarn instead"
      - "sed -i '/\\\"pack\\\"/c\\    \\\"pack:linux\\\": \\\"npm run
        build:linux && electron-builder --linux\\\",' package.json"
      # No need to prettify the code
      - sed -i -e "s/npm run lint:formatting && npm run lint:eslint && //"
        package.json
      # Remove lockfiles used by npm
      # - "find . -type f -name 'package-lock.json' -exec rm {} +"

      # Use the offline mirror.
      - 'HOME=$PWD yarn config --offline set yarn-offline-mirror
        $FLATPAK_BUILDER_BUILDDIR/flatpak-node/yarn-mirror'

      # Translated from npm run setup
      - npm --offline --save false ci
      - npm --offline --save false --prefix ./app install
      - yarn --offline --pure-lockfile --cwd ./web

      # - 'npm --offline --save false ci
      #   --cache=$FLATPAK_BUILDER_BUILDDIR/flatpak-node/npm-cache'
      # - 'npm --offline --save false --prefix ./web install
      #   --cache=$FLATPAK_BUILDER_BUILDDIR/flatpak-node/npm-cache'
      # - 'npm --offline --save false --prefix ./app ci
      #   --cache=$FLATPAK_BUILDER_BUILDDIR/flatpak-node/npm-cache'

      - yarn --offline run bundle
      - . flatpak-node/electron-builder-arch-args.sh &&
        ./node_modules/.bin/electron-builder --linux $ELECTRON_BUILDER_ARCH_ARGS
        --dir
      # Copy the resulting, unpacked directory to /app.
      # (A glob is used because the directory name may contain the current arch.)
      - 'cp -r dist/linux/*/linux*unpacked /app/standardnotes'

      # Install the wrapper script to start it.
      - 'install -Dm 755 start-standardnotes.sh /app/bin/start-standardnotes'

      # Retire this at some point when an SVG is available
      - install -Dm644 app/icon/Icon-256x256.png
        /app/share/icons/hicolor/256x256/apps/org.standardnotes.standardnotes.png
      - install -Dm644 app/icon/Icon-512x512.png
        /app/share/icons/hicolor/512x512/apps/org.standardnotes.standardnotes.png
    sources:
      # - type: file
      #   path: yarn.lock
      # - type: file
      #   path: yarn.app.lock
      #   dest-filename: yarn.lock
      #   dest: app
      # TODO: Replace with the git source
      # https://github.com/standardnotes/web/pull/516
      - type: archive
        sha256: baf51d6cfac760d8974faeff3256ddb9478ba363059d99ae3b61cd8b6c569825
        url: https://github.com/standardnotes/desktop/archive/v3.5.18.tar.gz
        git-init: true
      - type: archive
        url: https://github.com/standardnotes/web/archive/3.5.17.tar.gz
        sha256: 4aaeb7176904e3aacd31d53cf8dbd3037a2468321f726e97857df4f452f76ed9
        dest: web
      # - type: git
      #   url: https://github.com/sn-extensions/extensions-manager.git
      #   dest: web/vendor/extensions/extensions-manager
      # - type: git
      #   url: https://github.com/sn-extensions/extensions-manager.git
      #   dest: web/app/extensions/extensions-manager
      # - type: git
      #   url: https://github.com/sn-extensions/extensions-manager.git
      #   dest: web/public/extensions/extensions-manager
      # - type: git
      #   url: https://github.com/sn-extensions/extensions-manager.git
      #   dest: app/extensions/extensions-manager
      # - type: git
      #   url: https://github.com/sn-extensions/batch-manager.git
      #   dest: web/public/extensions/batch-manager
      # - type: git
      #   url: https://github.com/sn-extensions/batch-manager.git
      #   dest: app/extensions/batch-manager
      # - type: git
      #   # url: https://github.com/standardnotes/desktop
      #   # tag: v3.5.18
      #   path: ../standardnotes-desktop
      #   commit: master
      # Add the flatpak-node-generator generated sources.
      # Note to generate recursively with -r since the repo is composed by submodules
      # NPM
      - generated-sources.json
      # - generated-sources.app.json
      # YARN
      - generated-sources.web.json
      # Our runner script.
      - type: script
        dest-filename: start-standardnotes.sh
        commands:
          # Use zypak to call the electron binary to enable sandboxing and prevents no sandbox error
          - 'zypak-wrapper /app/standardnotes/standardnotes'
  - name: appdata
    buildsystem: simple
    build-commands:
      - install -Dm644 org.standardnotes.standardnotes.appdata.xml
        /app/share/metainfo/org.standardnotes.standardnotes.appdata.xml
    sources:
      - type: file
        path: org.standardnotes.standardnotes.appdata.xml
  - name: desktop-entry
    buildsystem: simple
    build-commands:
      - install -Dm644 org.standardnotes.standardnotes.desktop
        /app/share/applications/org.standardnotes.standardnotes.desktop
    sources:
      - type: file
        path: org.standardnotes.standardnotes.desktop
